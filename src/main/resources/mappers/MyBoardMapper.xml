<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.spring5legacy.mypro00.mapper.MyBoardMapper">

<!-- 게시물 조회 - 목록 -->
<!-- 	<select id="selectMyBoardList" resultType="com.spring5legacy.mypro00.domain.MyBoardVO">
		원하는 데이터를 조회하는 SELECT 문 작성: 반스시 SQL*Developer에서
			 원하는 결과를 반환하는지가 환인된 SELECT문을 복사해서 붙여넣기 합니다
		 문제: 게시물 전체 목록정보를 bno 기준 내림차순으로 정렬된 결과를 표시하는 SELECT문을 작성하시오
		SELECT bno, btitle, bcontent, bwriter, bregDate, bmodDate, bviewsCnt, breplyCnt, bdelFlag 
        FROM myuser.tbl_myboard
        ORDER BY bno DESC
	</select> -->
	
	<!-- 게시물 조회 - 목록, 페이징 -->
<!--     <select id="selectMyBoardList" resultType="com.spring5legacy.mypro00.domain.MyBoardVO">
    <![CDATA[
        SELECT bno, btitle, bcontent, bwriter, bregDate, bmodDate, bviewsCnt, breplyCnt, bdelFlag
        FROM ( SELECT /*+ INDEX_DESC (a pk_myboard) */ ROWNUM rn, a.*
                FROM  myuser.tbl_myboard a
                WHERE ROWNUM <= ( #{pageNum} * #{rowAmountPerPage} )
             )
        WHERE rn >= ( ( #{pageNum} * #{rowAmountPerPage} ) - ( #{rowAmountPerPage} - 1 ) )
    ]]>
    </select> -->
    
       <!-- 마이바티스 동적 태그 개요 및 실습 -->
   <select id="selectMyBoardList" resultType="com.spring5legacy.mypro00.domain.MyBoardVO">
      <![CDATA[
         SELECT b.bno, b.btitle, b.bwriter, b.bregDate, b.bmodDate, b.bviewsCnt, b.breplyCnt, b.bdelFlag
         FROM(SELECT /*+ INDEX_DESC (a pk_myboard) */ ROWNUM rn, a.*
              FROM myuser.tbl_myboard a
              WHERE  
       ]]>
            <choose>
               <when test='scope == "T".toString()'>btitle LIKE '%' || #{keyword} || '%' AND</when>
               <when test='scope == "C".toString()'>bcontent LIKE '%' || #{keyword} || '%' AND</when>
               <when test='scope == "W".toString()'>bwriter LIKE '%' || #{keyword} || '%' AND</when>
               <when test="scope == 'TC'.toString()">(btitle LIKE '%' || #{keyword} || '%' OR bcontent LIKE '%' || #{keyword} || '%') AND</when>
            </choose>
            <!-- 기간 조건 추가 -->
	         <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
	            <![CDATA[ (bregDate >= TO_DATE(#{startDate}, 'YYYY-MM-DD') AND bregDate < TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1) AND]]>
	         </if>
       <![CDATA[
              ROWNUM <= (#{pageNum} * #{rowAmountPerPage})    
             ) b
         WHERE b.rn >= ((#{pageNum} * #{rowAmountPerPage}) - (#{rowAmountPerPage} - 1)) 
      ]]>
   </select>
   
   
	
	<select id="selectRowTotal" resultType="Long">
	<![CDATA[
	    SELECT count(*) FROM myuser.tbl_myboard
	]]>
	    <where>
	        <trim prefix="(" suffix=")" prefixOverrides="OR">
	            <foreach item='scope' collection="scopeArray">
	                <trim prefix="OR">
	                    <choose>
	                        <when test="scope == 'T'.toString()">btitle LIKE '%'||#{keyword}||'%'</when>
	                        <when test="scope == 'C'.toString()">bcontent LIKE '%'||#{keyword}||'%'</when>
	                        <when test="scope == 'W'.toString()">bwriter LIKE '%'||#{keyword}||'%'</when>
	                        <when test="scope == 'TC'.toString()">(btitle LIKE '%' || #{keyword} || '%' OR bcontent LIKE '%' || #{keyword} || '%') AND</when>
	                    </choose>
	                </trim>
	            </foreach>
	        </trim>
	        <if test="(startDate != null and startDate != '') and (endDate != null and endDate != '')">
	            <![CDATA[ (bregDate >= TO_DATE(#{startDate}, 'YYYY-MM-DD') AND bregDate < TO_DATE(#{endDate}, 'YYYY-MM-DD') + 1)]]>
	         </if>
	    </where>
	</select>

    
    
    

	
	<!-- 게시물 등록 -->
    <insert id="insertMyBoard">
    	<selectKey keyProperty="bno" order="BEFORE" resultType="Long">
    		SELECT myuser.seq_myboard.nextval FROM dual
    	</selectKey>
        INSERT INTO myuser.tbl_myboard 
        VALUES (#{bno}, #{btitle}, #{bcontent}, #{bwriter}, DEFAULT, DEFAULT, DEFAULT, DEFAULT, DEFAULT)
    </insert>
	
	<insert id="insertMyBoardNoKey" parameterType="com.spring5legacy.mypro00.domain.MyBoardVO">
        INSERT INTO myuser.tbl_myboard 
        VALUES (
            seq_myboard.nextval, #{btitle}, #{bcontent}, #{bwriter}, 
            DEFAULT, DEFAULT, DEFAULT, DEFAULT, DEFAULT)
    </insert>
    


	<!-- 특정 게시물 조회 -->
<!-- 	<select id="selectMyBoard" resultType="com.spring5legacy.mypro00.domain.MyBoardVO">
		SELECT bno, btitle, bcontent, bwriter, bregDate, bmodDate, bviewsCnt, breplyCnt, bdelFlag 
		FROM myuser.tbl_myboard
		WHERE bno = #{bno}
	</select> -->
	
	<!-- 특정 게시물 조회(detail.jsp): OUTER JOIN 사용: 첨부파일이 없는 게시물도 결과에 포함되어야 함 -->   
	<!-- 첨부파일 정보 저장하기 위한 resultMap 정의 -->
	<resultMap type="com.spring5legacy.mypro00.domain.MyBoardAttachFileVO" id="attachFileMap">
		<result property="uuid" column="UUID"/>
		<result property="uploadPath" column="UPLOADPATH"/>
		<result property="fileName" column="FILENAME"/>
		<result property="fileType" column="FILETYPE"/>
		<result property="fileDelFlag" column="FILEDELFLAG"/>
	</resultMap>
	<!-- 게시물 정보를 저장하기 위한 resultMap 정의 -->
	<resultMap type="com.spring5legacy.mypro00.domain.MyBoardVO" id="myBoardMap">
	    <result property="bno" column="BNO"/>
	    <result property="btitle" column="BTITLE"/>
	    <result property="bcontent" column="BCONTENT"/>
	    <result property="bwriter" column="BWRITER"/>
	    <result property="bregDate" column="BREGDATE"/>
	    <result property="bmodDate" column="BMODDATE"/>
	    <result property="bviewsCnt" column="BVIEWSCNT"/>
	    <result property="breplyCnt" column="BREPLYCNT"/>
	    <result property="bdelFlag" column="BDELFLAG"/>
    	<collection property="attachFileList" resultMap="attachFileMap"/>

	</resultMap>

	<!-- 특정 게시물 조회 -->	
	<select id="selectMyBoard" resultMap="myBoardMap">
		SELECT b.BNO, b.BTITLE, b.BCONTENT, b.BWRITER, b.BREGDATE, 
		        b.BMODDATE, b.BVIEWSCNT, b.BREPLYCNT, b.BDELFLAG,
		        a.UUID,a.UPLOADPATH,a.FILENAME,a.FILETYPE,a.FILEDELFLAG
		FROM myuser.TBL_MYBOARD b
		LEFT OUTER JOIN myuser.TBL_MYATTACHFILES a ON b.BNO = a.BNO
		WHERE b.BNO = #{bno}
	</select>
	
	
	
<!--  
SELECT b.BNO, b.BTITLE, b.BCONTENT, b.BWRITER, b.BREGDATE, 
        b.BMODDATE, b.BVIEWSCNT, b.BREPLYCNT, b.BDELFLAG,
        a.UUID,a.UPLOADPATH,a.FILENAME,a.FILETYPE,a.FILEDELFLAG
FROM myuser.TBL_MYBOARD b
LEFT OUTER JOIN myuser.TBL_MYATTACHFILES a ON b.BNO = a.BNO
WHERE b.BNO = 30781;
-->
	
	<!-- 특정 게시물 수정 -->
	<update id="updateMyBoard">
		UPDATE myuser.tbl_myboard
		SET btitle = #{btitle},
            bcontent = #{bcontent},
            bmodDate = DEFAULT
		WHERE bno = #{bno}
	</update>
	
	<!-- 특정 게시물 삭제 요청 - 헤당 글의 bdelFlag = 1 -->
	<update id="updateBdelFlag">
		UPDATE myuser.tbl_myboard
		SET bdelFlag = 1
		WHERE bno = #{bno}
	</update>
	
	<!-- 특정 게시물 삭제 - 실제 삭제 -->
	<delete id="deleteMyBoard">
		DELETE myuser.tbl_myboard
		WHERE bno = #{bno}
	</delete>
	

	<!-- 특정 게시물 조회수 증가 : 게시물 조회 시 + 1 -->
	<update id="updateBviewsCnt" parameterType="java.lang.Long">
		UPDATE myuser.tbl_myboard
	 	SET bviewsCnt = bviewsCnt + 1 
	 	WHERE bno = #{bno}
	</update>
	

	<update id="updateBreplyCnt">
		UPDATE myuser.tbl_myboard 
		SET breplyCnt = breplyCnt + #{amt}
		WHERE bno = #{bno}
	</update>
	

	


</mapper>